<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">
<head>
  <meta charset="UTF-8" />
  <title>부모용 목표 모니터링 | Yongha</title>
  <th:block layout:fragment="head">
    <link rel="stylesheet" href="/css/goal.css">
    <link rel="stylesheet" href="/css/goal-parent.css">
    <style>
      /* ✅ 모든 앵커 스크롤 부드럽게 */
      html { scroll-behavior: smooth; }
    </style>
  </th:block>
</head>
<body>
<main layout:fragment="content" class="content">

	<!-- HERO -->
	<section class="hero-yg">   <!-- ⛔ section-bg-light 제거 -->
	  <div class="hero-inner">
	    <div class="hero-copy">
	      <h1>아이 목표, <b>한 눈에 모니터링</b></h1>
	      <p>자녀별 목표 진행률과 달성 현황을 스마트하게 확인하세요.</p>
	      <div class="hero-actions">
	        <a href="#children-goals" class="btn-pill btn-outline">목록 보기</a>
	      </div>
	    </div>
	    <div class="hero-visual" aria-hidden="true">
	      <img th:src="@{/img/familyyong.png}" src="/img/familyyong.png"
	           alt="용하 가족" width="480" height="480" loading="eager"
	           decoding="async">
	    </div>
	  </div>
	</section>


  <!-- 안내 박스 -->
  <section class="guide-box section-bg-white card">
    <h2>📊 부모용 자녀 목표 모니터링</h2>
    <p>자녀별 목표 진행 상황과 달성률을 한눈에 확인하세요.</p>
  </section>

  <!-- 부모 전용: 자녀별 목표 카드 -->
  <section class="parent-goals section-bg-gray">
    <h2>🎯 자녀별 목표 현황</h2>
    <div class="children-goals" id="children-goals">
      <!-- JS에서 자녀 카드 append -->
    </div>
  </section>

  <!-- 이번 달 최고 달성 유저 -->
  <section class="highlight-banner section-bg-light card" id="best-banner">
    <span class="tag best">🏆 BEST 달성 유저</span>
    <div class="highlight-card">
      <img id="best-avatar" src="/img/profile/profile0.png" alt="이번달 유저" class="highlight-avatar">
	   <div class="highlight-info">
	      <h3 id="best-name">-</h3>
	      <p>
	        <span id="best-goal">-</span> 목표 달성률 <b id="best-pct">0%</b> 달성 🎉
	      </p>
       </div>
    </div>
  </section>

  <!-- 인기 목표 아이템 -->
  <section class="popular-goals section-bg-yellow">
    <h2>🔥 인기 목표 아이템</h2>
    <div class="popular-list">
      <div class="popular-card card">
        <span class="emoji">🎮</span>
        <h3>닌텐도 스위치</h3>
        <p>이번달 최다 등록 목표</p>
      </div>
      <div class="popular-card card">
        <span class="emoji">🚲</span>
        <h3>자전거</h3>
        <p>활동적인 아이들 인기</p>
      </div>
      <div class="popular-card card">
        <span class="emoji">📱</span>
        <h3>스마트폰</h3>
        <p>청소년 선호도 1위</p>
      </div>
    </div>
  </section>

  <!-- 부모 TIP -->
  <section class="parent-tips section-bg-white card">
    <h2>💡 용돈 관리 꿀팁</h2>
    <ul>
      <li>📋 목표는 구체적으로! 아이와 함께 세부 목표를 정해보세요.</li>
      <li>💰 저축 습관 키우기. 달성 시 용돈 보너스를 제안해보세요.</li>
      <li>🤝 함께 점검. 주말마다 진행률을 같이 확인해요.</li>
    </ul>
  </section>

  <!-- GOAL_TYPE_CODES 주입 -->
  <script th:inline="javascript">
    const GOAL_TYPE_CODES = /*[[${GOAL_TYPE_CODES}]]*/ [];

    const getEmojiByCode = (code) => {
      const m = GOAL_TYPE_CODES.find(c => String(c.value) === String(code));
      return (m && m.desc) ? m.desc : '🎯';
    };
    const getLabelByCode = (code) => {
      const m = GOAL_TYPE_CODES.find(c => String(c.value) === String(code));
      return m?.label || '기타';
    };
  </script>

  <!-- JS (백엔드 로직 변경 없음) -->
  <script>
    const esc = s => String(s ?? '').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
    const won = n => (Number(n)||0).toLocaleString('ko-KR') + '원';
    const pct = (saved, target) => target > 0 ? Math.min(100, Math.floor((saved / target) * 100)) : 0;

    async function fetchGroups() {
      const r = await fetch('/api/goals/parent/goals', { credentials: 'same-origin' });
      if (!r.ok) throw new Error(await r.text());
      return r.json();
    }

    function mapGoal(row) {
      const achieved = Number(row.achieved) === 1;
      const target   = Number(row.target_amount) || 0;
      const balance  = Number(row.balance) || 0;
      const saved    = achieved ? target : Math.min(balance, target);
      return {
        id: row.goal_no,
        title: row.goal_name,
        icon: row.goal_type,
        target, saved, done: achieved
      };
    }

    function buildChildCard(child) {
      const goals = (child.goals || []).map(mapGoal);
      const g = goals.find(x => !x.done);

      return `
        <div class="child-card card">
          <div class="child-avatar">
            <img src="/img/profile/profile${child.profile || 0}.png" alt="${esc(child.child_name)} 프로필"/>
          </div>
          <h3 class="child-name">${esc(child.child_name)}</h3>
          ${
            g ? `
              <div class="goal-card">
                <h4>${esc(g.title)}</h4>
                <p class="goal-progress">${won(g.saved)} / ${won(g.target)} (${pct(g.saved,g.target)}%)</p>
                <div class="progress-bar"><span style="width:${pct(g.saved,g.target)}%"></span></div>
                <span class="goal-status progress">진행중</span>
              </div>
            ` : `
              <div class="goal-card empty">
                <p>현재 진행 중인 목표 없음</p>
                <span class="goal-status empty">대기</span>
              </div>
            `
          }
        </div>
      `;
    }
    
    function pickBestOngoingGoal(groups) {
        // groups: [{ child_no, child_name, profile, goals:[...] }, ...]
        // mapGoal(row) 적용 후 진행중(!done) + target>0 중에서 최고 pct 1개 고름
        let best = null;

        for (const child of (groups || [])) {
          const goals = (child.goals || []).map(mapGoal);
          for (const g of goals) {
            if (g.done) continue;                 // 완료 제외
            if (!g.target || g.target <= 0) continue;

            const progress = pct(g.saved, g.target); // 0~100
            const candidate = {
              childName: child.child_name,
              profile: child.profile || 0,
              goalTitle: g.title,
              progress, saved: g.saved, target: g.target
            };

            // tie-break: 진행률 > 적립액(원) > 목표금액(큰 쪽 우선)
            if (
              !best ||
              candidate.progress > best.progress ||
              (candidate.progress === best.progress && candidate.saved > best.saved) ||
              (candidate.progress === best.progress && candidate.saved === best.saved && candidate.target > best.target)
            ) {
              best = candidate;
            }
          }
        }
        return best;
      }

      function renderBestBanner(best) {
        const banner = document.getElementById('best-banner');
        if (!banner) return;

        if (!best) {
          // 진행 중 목표가 없으면 감춤
          banner.hidden = true;
          return;
        }

        // 요소 채우기
        const $avatar = document.getElementById('best-avatar');
        const $name   = document.getElementById('best-name');
        const $goal   = document.getElementById('best-goal');
        const $pct    = document.getElementById('best-pct');

        if ($avatar) $avatar.src = `/img/profile/profile${best.profile}.png`;
        if ($name)   $name.textContent = best.childName || '자녀';
        if ($goal)   $goal.textContent = best.goalTitle || '목표';
        if ($pct)    $pct.textContent  = `${best.progress}%`;

        banner.hidden = false;
      }

    async function refresh() {
      let groups = await fetchGroups();
      if (!Array.isArray(groups)) groups = [];
      const container = document.getElementById('children-goals');
      container.innerHTML = groups.map(buildChildCard).join('');
      const best = pickBestOngoingGoal(groups); // BEST 달성 자녀 랜더링
      renderBestBanner(best);
    }
    refresh().catch(console.error);
  </script>
</main>
</body>
</html>
