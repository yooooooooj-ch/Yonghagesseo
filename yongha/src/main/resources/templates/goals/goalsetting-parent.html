<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">
<head>
  <meta charset="UTF-8" />
  <title>ë¶€ëª¨ìš© ëª©í‘œ ëª¨ë‹ˆí„°ë§ | Yongha</title>
  <th:block layout:fragment="head">
    <link rel="stylesheet" href="/css/goal.css">
    <link rel="stylesheet" href="/css/goal-parent.css">
    <style>
      /* âœ… ëª¨ë“  ì•µì»¤ ìŠ¤í¬ë¡¤ ë¶€ë“œëŸ½ê²Œ */
      html { scroll-behavior: smooth; }
    </style>
  </th:block>
</head>
<body>
<main layout:fragment="content" class="content">

	<!-- HERO -->
	<section class="hero-yg">   <!-- â›” section-bg-light ì œê±° -->
	  <div class="hero-inner">
	    <div class="hero-copy">
	      <h1>ì•„ì´ ëª©í‘œ, <b>í•œ ëˆˆì— ëª¨ë‹ˆí„°ë§</b></h1>
	      <p>ìë…€ë³„ ëª©í‘œ ì§„í–‰ë¥ ê³¼ ë‹¬ì„± í˜„í™©ì„ ìŠ¤ë§ˆíŠ¸í•˜ê²Œ í™•ì¸í•˜ì„¸ìš”.</p>
	      <div class="hero-actions">
	        <a href="#children-goals" class="btn-pill btn-outline">ëª©ë¡ ë³´ê¸°</a>
	      </div>
	    </div>
	    <div class="hero-visual" aria-hidden="true">
	      <img th:src="@{/img/familyyong.png}" src="/img/familyyong.png"
	           alt="ìš©í•˜ ê°€ì¡±" width="480" height="480" loading="eager"
	           decoding="async">
	    </div>
	  </div>
	</section>


  <!-- ì•ˆë‚´ ë°•ìŠ¤ -->
  <section class="guide-box section-bg-white card">
    <h2>ğŸ“Š ë¶€ëª¨ìš© ìë…€ ëª©í‘œ ëª¨ë‹ˆí„°ë§</h2>
    <p>ìë…€ë³„ ëª©í‘œ ì§„í–‰ ìƒí™©ê³¼ ë‹¬ì„±ë¥ ì„ í•œëˆˆì— í™•ì¸í•˜ì„¸ìš”.</p>
  </section>

  <!-- ë¶€ëª¨ ì „ìš©: ìë…€ë³„ ëª©í‘œ ì¹´ë“œ -->
  <section class="parent-goals section-bg-gray">
    <h2>ğŸ¯ ìë…€ë³„ ëª©í‘œ í˜„í™©</h2>
    <div class="children-goals" id="children-goals">
      <!-- JSì—ì„œ ìë…€ ì¹´ë“œ append -->
    </div>
  </section>

  <!-- ì´ë²ˆ ë‹¬ ìµœê³  ë‹¬ì„± ìœ ì € -->
  <section class="highlight-banner section-bg-light card" id="best-banner">
    <span class="tag best">ğŸ† BEST ë‹¬ì„± ìœ ì €</span>
    <div class="highlight-card">
      <img id="best-avatar" src="/img/profile/profile0.png" alt="ì´ë²ˆë‹¬ ìœ ì €" class="highlight-avatar">
	   <div class="highlight-info">
	      <h3 id="best-name">-</h3>
	      <p>
	        <span id="best-goal">-</span> ëª©í‘œ ë‹¬ì„±ë¥  <b id="best-pct">0%</b> ë‹¬ì„± ğŸ‰
	      </p>
       </div>
    </div>
  </section>

  <!-- ì¸ê¸° ëª©í‘œ ì•„ì´í…œ -->
  <section class="popular-goals section-bg-yellow">
    <h2>ğŸ”¥ ì¸ê¸° ëª©í‘œ ì•„ì´í…œ</h2>
    <div class="popular-list">
      <div class="popular-card card">
        <span class="emoji">ğŸ®</span>
        <h3>ë‹Œí…ë„ ìŠ¤ìœ„ì¹˜</h3>
        <p>ì´ë²ˆë‹¬ ìµœë‹¤ ë“±ë¡ ëª©í‘œ</p>
      </div>
      <div class="popular-card card">
        <span class="emoji">ğŸš²</span>
        <h3>ìì „ê±°</h3>
        <p>í™œë™ì ì¸ ì•„ì´ë“¤ ì¸ê¸°</p>
      </div>
      <div class="popular-card card">
        <span class="emoji">ğŸ“±</span>
        <h3>ìŠ¤ë§ˆíŠ¸í°</h3>
        <p>ì²­ì†Œë…„ ì„ í˜¸ë„ 1ìœ„</p>
      </div>
    </div>
  </section>

  <!-- ë¶€ëª¨ TIP -->
  <section class="parent-tips section-bg-white card">
    <h2>ğŸ’¡ ìš©ëˆ ê´€ë¦¬ ê¿€íŒ</h2>
    <ul>
      <li>ğŸ“‹ ëª©í‘œëŠ” êµ¬ì²´ì ìœ¼ë¡œ! ì•„ì´ì™€ í•¨ê»˜ ì„¸ë¶€ ëª©í‘œë¥¼ ì •í•´ë³´ì„¸ìš”.</li>
      <li>ğŸ’° ì €ì¶• ìŠµê´€ í‚¤ìš°ê¸°. ë‹¬ì„± ì‹œ ìš©ëˆ ë³´ë„ˆìŠ¤ë¥¼ ì œì•ˆí•´ë³´ì„¸ìš”.</li>
      <li>ğŸ¤ í•¨ê»˜ ì ê²€. ì£¼ë§ë§ˆë‹¤ ì§„í–‰ë¥ ì„ ê°™ì´ í™•ì¸í•´ìš”.</li>
    </ul>
  </section>

  <!-- GOAL_TYPE_CODES ì£¼ì… -->
  <script th:inline="javascript">
    const GOAL_TYPE_CODES = /*[[${GOAL_TYPE_CODES}]]*/ [];

    const getEmojiByCode = (code) => {
      const m = GOAL_TYPE_CODES.find(c => String(c.value) === String(code));
      return (m && m.desc) ? m.desc : 'ğŸ¯';
    };
    const getLabelByCode = (code) => {
      const m = GOAL_TYPE_CODES.find(c => String(c.value) === String(code));
      return m?.label || 'ê¸°íƒ€';
    };
  </script>

  <!-- JS (ë°±ì—”ë“œ ë¡œì§ ë³€ê²½ ì—†ìŒ) -->
  <script>
    const esc = s => String(s ?? '').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
    const won = n => (Number(n)||0).toLocaleString('ko-KR') + 'ì›';
    const pct = (saved, target) => target > 0 ? Math.min(100, Math.floor((saved / target) * 100)) : 0;

    async function fetchGroups() {
      const r = await fetch('/api/goals/parent/goals', { credentials: 'same-origin' });
      if (!r.ok) throw new Error(await r.text());
      return r.json();
    }

    function mapGoal(row) {
      const achieved = Number(row.achieved) === 1;
      const target   = Number(row.target_amount) || 0;
      const balance  = Number(row.balance) || 0;
      const saved    = achieved ? target : Math.min(balance, target);
      return {
        id: row.goal_no,
        title: row.goal_name,
        icon: row.goal_type,
        target, saved, done: achieved
      };
    }

    function buildChildCard(child) {
      const goals = (child.goals || []).map(mapGoal);
      const g = goals.find(x => !x.done);

      return `
        <div class="child-card card">
          <div class="child-avatar">
            <img src="/img/profile/profile${child.profile || 0}.png" alt="${esc(child.child_name)} í”„ë¡œí•„"/>
          </div>
          <h3 class="child-name">${esc(child.child_name)}</h3>
          ${
            g ? `
              <div class="goal-card">
                <h4>${esc(g.title)}</h4>
                <p class="goal-progress">${won(g.saved)} / ${won(g.target)} (${pct(g.saved,g.target)}%)</p>
                <div class="progress-bar"><span style="width:${pct(g.saved,g.target)}%"></span></div>
                <span class="goal-status progress">ì§„í–‰ì¤‘</span>
              </div>
            ` : `
              <div class="goal-card empty">
                <p>í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ëª©í‘œ ì—†ìŒ</p>
                <span class="goal-status empty">ëŒ€ê¸°</span>
              </div>
            `
          }
        </div>
      `;
    }
    
    function pickBestOngoingGoal(groups) {
        // groups: [{ child_no, child_name, profile, goals:[...] }, ...]
        // mapGoal(row) ì ìš© í›„ ì§„í–‰ì¤‘(!done) + target>0 ì¤‘ì—ì„œ ìµœê³  pct 1ê°œ ê³ ë¦„
        let best = null;

        for (const child of (groups || [])) {
          const goals = (child.goals || []).map(mapGoal);
          for (const g of goals) {
            if (g.done) continue;                 // ì™„ë£Œ ì œì™¸
            if (!g.target || g.target <= 0) continue;

            const progress = pct(g.saved, g.target); // 0~100
            const candidate = {
              childName: child.child_name,
              profile: child.profile || 0,
              goalTitle: g.title,
              progress, saved: g.saved, target: g.target
            };

            // tie-break: ì§„í–‰ë¥  > ì ë¦½ì•¡(ì›) > ëª©í‘œê¸ˆì•¡(í° ìª½ ìš°ì„ )
            if (
              !best ||
              candidate.progress > best.progress ||
              (candidate.progress === best.progress && candidate.saved > best.saved) ||
              (candidate.progress === best.progress && candidate.saved === best.saved && candidate.target > best.target)
            ) {
              best = candidate;
            }
          }
        }
        return best;
      }

      function renderBestBanner(best) {
        const banner = document.getElementById('best-banner');
        if (!banner) return;

        if (!best) {
          // ì§„í–‰ ì¤‘ ëª©í‘œê°€ ì—†ìœ¼ë©´ ê°ì¶¤
          banner.hidden = true;
          return;
        }

        // ìš”ì†Œ ì±„ìš°ê¸°
        const $avatar = document.getElementById('best-avatar');
        const $name   = document.getElementById('best-name');
        const $goal   = document.getElementById('best-goal');
        const $pct    = document.getElementById('best-pct');

        if ($avatar) $avatar.src = `/img/profile/profile${best.profile}.png`;
        if ($name)   $name.textContent = best.childName || 'ìë…€';
        if ($goal)   $goal.textContent = best.goalTitle || 'ëª©í‘œ';
        if ($pct)    $pct.textContent  = `${best.progress}%`;

        banner.hidden = false;
      }

    async function refresh() {
      let groups = await fetchGroups();
      if (!Array.isArray(groups)) groups = [];
      const container = document.getElementById('children-goals');
      container.innerHTML = groups.map(buildChildCard).join('');
      const best = pickBestOngoingGoal(groups); // BEST ë‹¬ì„± ìë…€ ëœë”ë§
      renderBestBanner(best);
    }
    refresh().catch(console.error);
  </script>
</main>
</body>
</html>
