<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/layout}">
<head>
<meta charset="UTF-8" />
<title>ì•„ì´ìš© ëª©í‘œ ì„¤ì • | Yongha</title>
<th:block layout:fragment="head">
	<link rel="stylesheet" th:href="@{/css/goal.css}">
</th:block>
</head>
<body>
	<main layout:fragment="content" class="content">

		<!-- HERO -->
		<section class="hero-yg" aria-label="yongha-hero">
			<div class="hero-inner">
				<div class="hero-copy">
					<span class="badge">My Goals</span>
					<h1>
						ë‚´ ëª©í‘œë¥¼ <b>ì§ì ‘ ë§Œë“¤ê³ </b> ë‹¬ì„±í•´ìš”
					</h1>
					<p>ì‘ê²Œ ì‹œì‘í•´ì„œ ê¾¸ì¤€íˆ ì±„ìš°ë©´ ì–´ëŠìƒˆ ë„ì°©!</p>
					<div class="hero-actions">
						<button type="button" class="btn-pill btn-yellow" id="cta-start">+
							ìƒˆ ëª©í‘œ ë§Œë“¤ê¸°</button>
						<a href="#gs-list" class="btn-pill btn-outline">ë‚´ ëª©í‘œ ë³´ê¸°</a>
					</div>
				</div>
				<div class="hero-visual" aria-hidden="true">
					<img th:src="@{/img/familyyong.png}" src="/img/familyyong.png"
						alt="ìš©í•˜ ê°€ì¡±" width="640" height="640" loading="eager"
						decoding="async" sizes="(max-width: 960px) 80vw, 420px">
				</div>
			</div>
		</section>

		<!-- ì•„ì´ ì„ íƒ(ë‹¨ì¼ì´ë©´ ìˆ¨ê²¨ë„ OK) + KPI + ì¶”ê°€ë²„íŠ¼ -->
		<section class="gs-wrap">
			<header class="gs-header">
				<div class="gs-title">
					<h1>ì•„ì´ìš© â€” ëª©í‘œ ì„¤ì •</h1>
					<p class="gs-muted">ëª©í‘œë¥¼ ë§Œë“¤ê³ , ì ë¦½í•˜ê³ , ë‹¬ì„±í•´ ë³´ì„¸ìš”.</p>
				</div>
				<div class="gs-stats">
<!-- 					<label class="gs-field" style="margin-right: 12px;"> <span -->
<!-- 						style="font-size: 12px; color: #64748b;">ë‚´ ID</span> <select -->
<!-- 						id="childId"> -->
<!-- 							<option value="kid1">kid1</option> -->
<!-- 					</select> -->
<!-- 					</label>  -->
					<span class="gs-pill" id="gs-pill-total">ì´ 0ê°œ</span> <span
						class="gs-pill" id="gs-pill-progress">ì§„í–‰ 0ê°œ</span> <span
						class="gs-pill" id="gs-pill-done">ë‹¬ì„± 0ê°œ</span>
					<button class="gs-btn gs-primary" id="gs-btn-add" type="button">+
						ìƒˆ ëª©í‘œ</button>
				</div>
			</header>

			<div class="gs-card">
				<div id="gs-list" class="gs-grid"></div>
				<div id="gs-empty" class="gs-empty" hidden>
					ì•„ì§ ëª©í‘œê°€ ì—†ì–´ìš”. <b>+ ìƒˆ ëª©í‘œ</b>ë¡œ ì‹œì‘í•´ìš”! ğŸ£
				</div>
			</div>

			<aside class="gs-help" style="margin-top: 12px;">
				<div class="gs-card gs-help-card">
					<h3>TIP</h3>
					<ul>
						<li>ëª©í‘œ ê¸ˆì•¡ì€ ë„ˆë¬´ í¬ê²Œ ì¡ì§€ ì•Šê¸°!</li>
						<li>ì´ë¯¸ì§€ë¥¼ ì˜¬ë¦¬ë©´ ë” ë³´ê¸° ì¢‹ì•„ìš”.</li>
						<li>ì™„ë£Œí•˜ë©´ ìë™ìœ¼ë¡œ 100%ê°€ ë©ë‹ˆë‹¤.</li>
					</ul>
				</div>
			</aside>
		</section>

		<!-- ìƒˆ ëª©í‘œ ëª¨ë‹¬ -->
		<dialog id="gs-dlg" class="gs-dialog" aria-labelledby="gs-dlg-title">
		<form method="dialog" id="gs-form">
			<div class="gs-dlg-h">
				<strong id="gs-dlg-title">ìƒˆ ëª©í‘œ</strong>
				<!-- ë‹«ê¸° ë²„íŠ¼ -->
				<button class="gs-btn" type="button" aria-label="ë‹«ê¸°"
					onclick="document.getElementById('gs-dlg').close()">ë‹«ê¸°</button>
			</div>
			<div class="gs-dlg-b">
				<label class="gs-field"> <span>ëª©í‘œ ì´ë¦„</span> <input
					id="gs-title" name="title" placeholder="ì˜ˆ) ê³¼í•™ì±… ì‚¬ê¸°" required />
				</label>
		        <label class="gs-field">
		          <span>ëª©í‘œ ê¸ˆì•¡ (ì›)</span>
		          <input id="gs-target" name="target" type="number" min="1000" step="100" placeholder="20000" required/>
		        </label>
				<label class="gs-field"> <span>ì•„ì´ì½˜</span> <select
					id="gs-icon" name="icon">
						<option th:each="g : ${GOAL_TYPE_CODES}" th:value="${g.value}"
							th:text="${(g.desc != null ? g.desc + ' ' : '') + g.label}">
						</option>
				</select>
				</label>
			</div>
			<div class="gs-dlg-a">
				<button class="gs-btn gs-primary" value="default" type="submit">ì €ì¥</button>
			</div>
		</form>
		</dialog>

		<!-- JS (ì•„ì´ìš©: full control) -->
		<script>
		/* ==== Helpers ==== */
		const $ = (s, el = document) => el.querySelector(s);
		const esc = s => String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
		const won = n => (Number(n)||0).toLocaleString('ko-KR') + 'ì›';
		
		const listEl      = $('#gs-list');
		const emptyEl     = $('#gs-empty');
		const pillTotal   = $('#gs-pill-total');
		const pillProgress= $('#gs-pill-progress');
		const pillDone    = $('#gs-pill-done');
		const btnAdd      = $('#gs-btn-add');
		const dlg         = $('#gs-dlg');
		const form        = $('#gs-form');
		const titleEl     = $('#gs-title');
		const iconEl      = $('#gs-icon');
		const targetEl    = $('#gs-target'); // (child UIì—ì„  ì£¼ì„ ì²˜ë¦¬ë˜ì–´ ìˆì„ ìˆ˜ ìˆìŒ)
		const hasTargetEl = !!targetEl;
		
		let goalsCache = [];
		let editingId = null;
		let editingGoalSnapshot = null; // ìˆ˜ì • ì‹œ ê¸°ì¡´ ê°’ ë³´ê´€
		
		/* ==== API (goalsetting.htmlê³¼ ë™ì¼ íŒ¨í„´) ==== */
		const api = {
		  async list() {
		    const res = await fetch('/api/goals', { credentials: 'same-origin' });
		    if (!res.ok) throw new Error(await res.text());
		    return res.json();
		  },
		  async create({ goal_name, target_amount, goal_type }) {
		    const res = await fetch('/api/goals', {
		      method: 'POST',
		      headers: { 'Content-Type': 'application/json' },
		      credentials: 'same-origin',
		      body: JSON.stringify({ goal_name, target_amount, goal_type })
		    });
		    if (res.status === 409) {
		      const msg = await res.text();
		      const e = new Error(msg || 'ì´ë¯¸ ì§„í–‰ ì¤‘ì¸ ëª©í‘œê°€ ìˆìŠµë‹ˆë‹¤.');
		      e.code = 409; throw e;
		    }
		    if (!res.ok) throw new Error((await res.text()) || 'ì €ì¥ ì‹¤íŒ¨');
		    return res.text();
		  },
		  async patch(goalNo, { goal_name, target_amount, goal_type }) {
		    const res = await fetch(`/api/goals/${goalNo}`, {
		      method: 'PATCH',
		      headers: { 'Content-Type': 'application/json' },
		      credentials: 'same-origin',
		      body: JSON.stringify({ goal_name, target_amount, goal_type })
		    });
		    if (!res.ok) throw new Error((await res.text()) || 'ìˆ˜ì • ì‹¤íŒ¨');
		    return res.text();
		  },
		  async remove(goalNo) {
		    const res = await fetch(`/api/goals/${goalNo}`, {
		      method: 'DELETE', credentials: 'same-origin'
		    });
		    if (!res.ok) throw new Error((await res.text()) || 'ì‚­ì œ ì‹¤íŒ¨');
		    return res.text();
		  },
		  async complete(goalNo) {
		    const res = await fetch(`/api/goals/${goalNo}/complete`, {
		      method: 'POST', credentials: 'same-origin'
		    });
		    if (!res.ok) throw new Error((await res.text()) || 'ë‹¬ì„± ì‹¤íŒ¨');
		    return res.text();
		  }
		};
		
		// <select id="gs-icon"> ì˜µì…˜ì„ ê·¸ëŒ€ë¡œ ì½ì–´ ì½”ë“œâ†’ë¼ë²¨(ì˜ˆ: "ğŸ® ê²Œì„") ë§¤í•‘
		const goalTypeLabelByCode = (() => {
		  const map = {};
		  const sel = document.getElementById('gs-icon');
		  if (sel) [...sel.options].forEach(o => map[String(o.value)] = (o.text || '').trim());
		  return map;
		})();

		// ì½”ë“œê°’ìœ¼ë¡œ ì´ëª¨ì§€/ë¼ë²¨ ì–»ê¸°
		const getEmojiByCode = (code) => {
		  const txt = goalTypeLabelByCode[String(code)] || '';
		  const m = txt.match(/^\p{Extended_Pictographic}/u);
		  return m ? m[0] : 'ğŸ¯';
		};
		const getLabelByCode = (code) =>
		  (goalTypeLabelByCode[String(code)] || '').replace(/^\p{Extended_Pictographic}\s*/u, '') || 'ê¸°íƒ€';

		
		/* ==== Mapping (goalsetting.htmlê³¼ ë™ì¼) ==== */
		function mapRow(row) {
		  const achieved = Number(row.achieved) === 1;
		  const target   = Number(row.target_amount) || 0;
		  const balance  = Number(row.balance) || 0;
		  const saved    = achieved ? target : Math.min(balance, target);
		  const ready    = Number(row.ready_to_complete) === 1;
		  return {
		    id: row.goal_no,
		    title: row.goal_name,
		    icon: row.goal_type,   // ìˆ«ì ì½”ë“œ
		    target,
		    done: achieved,
		    saved,
		    ready,
		    img: ''
		  };
		}
		
		async function reload() {
		  const rows = await api.list();
		  goalsCache = (rows || []).map(mapRow);
		  render();
		  // ëª¨ë‹¬ì—ì„œ ì´ì „ í¸ì§‘ ìŠ¤ëƒ…ìƒ·ì€ ë” ì´ìƒ ìœ íš¨í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ì´ˆê¸°í™”
		  editingGoalSnapshot = null;
		}
		
		function render() {
		  const goals = [...goalsCache];
		
		  pillTotal.textContent    = `ì´ ${goals.length}ê°œ`;
		  const progressing        = goals.filter(g => !g.done).length;
		  pillProgress.textContent = `ì§„í–‰ ${progressing}ê°œ`;
		  const completed          = goals.filter(g => g.done).length;
		  pillDone.textContent     = `ë‹¬ì„± ${completed}ê°œ`;
		
		  listEl.innerHTML = '';
		  emptyEl.hidden = goals.length > 0;
		
		  goals.sort((a,b) => Number(a.done) - Number(b.done));
		  goals.forEach(g => listEl.appendChild(goalCard(g)));
		
		  // ì§„í–‰ì¤‘ ëª©í‘œ ìˆìœ¼ë©´ ìƒˆ ëª©í‘œ ë²„íŠ¼ ìš”ì†Œ ìˆ¨ê¹€ì²˜ë¦¬
		  const hasActive = goals.some(g => !g.done);
		  if (hasActive) {
		    btnAdd.style.display = 'none';
		    document.getElementById('cta-start').style.display = 'none';
		  } else {
		    btnAdd.style.display = '';
		    document.getElementById('cta-start').style.display = '';
		  }
		}
		
		function goalCard(g) {
		  const p = g.target ? Math.round((g.saved / g.target) * 100) : 0;
		  const manualDoneOnlyTarget = g.done;

		  // â¬‡ ì¶”ê°€
		  const emoji = getEmojiByCode(g.icon);
		  const label = getLabelByCode(g.icon);

		  const wrap = document.createElement('article');
		  wrap.className = 'ge-item' + (g.done ? ' is-done' : '');

		  wrap.innerHTML = `
		    ${g.done ? `<span class="ge-stamp">CLEAR</span>` : ``}
		    <header class="ge-head">
		      <h3 class="ge-title">${esc(g.title)}</h3>
		      <span class="ge-state ${g.done ? 'done':''}">${g.done ? 'ë‹¬ì„± ì™„ë£Œ' : 'ì§„í–‰ì¤‘'}</span>
		    </header>
		    <div class="ge-body">
		      <div class="ge-media">
		        <div class="ge-emoji" title="${esc(label)}" aria-label="${esc(label)}">${emoji}</div>
		      </div>
		      <div class="ge-main">
		        ${
		          manualDoneOnlyTarget
		          ? `<div class="ge-meta">ëª©í‘œê¸ˆì•¡: ${won(g.target)}</div>`
		          : `
		            <div class="ge-meta">${won(g.saved)} / ${won(g.target)} 
		              <span class="ge-percent">(${p}%)</span>
		            </div>
		            <div class="ge-progress"><span style="--p:${Math.min(100, Math.max(0, p))}%"></span></div>
		          `
		        }
		        <div class="ge-actions-row">
		          ${g.done
		            ? `<span class="gs-pill ok">âœ… ë‹¬ì„± ì™„ë£Œ</span>`
		            : `<button class="ge-btn" data-done type="button">ì™„ë£Œ</button>`
		          }
		          <div class="ge-actions-right">
		            <button class="ge-btn" data-edit type="button">ìˆ˜ì •</button>
		            <button class="ge-btn danger" data-del type="button">ì‚­ì œ</button>
		          </div>
		        </div>
		      </div>
		    </div>
		  `;
		
		  wrap.querySelector('[data-edit]')?.addEventListener('click', () => openEdit(g.id, g));
		  wrap.querySelector('[data-del]')?.addEventListener('click', () => removeGoal(g.id));
		  wrap.querySelector('[data-done]')?.addEventListener('click', () => markDone(g.id));
		
		  return wrap;
		}
		
		/* ==== Modal(Create/Update) ==== */
		btnAdd?.addEventListener('click', async () => {
		  if (goalsCache.some(g => !g.done)) {
		    await showAlert({
		      title: 'ì§„í–‰ ì¤‘ ëª©í‘œ',
		      text: 'ì´ë¯¸ ì§„í–‰ ì¤‘ì¸ ëª©í‘œê°€ ìˆì–´ìš”.\në¨¼ì € ë‹¬ì„±/ì‚­ì œí•œ ë’¤ ìƒˆ ëª©í‘œë¥¼ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
		      icon: 'warning'
		    });
		    return;
		  }
		  editingId = null;
		  editingGoalSnapshot = null;
		  form.reset();
		  dlg.showModal ? dlg.showModal() : dlg.removeAttribute('hidden');
		});

		// Top Layer flush helper: ë‹¤ì´ì–¼ë¡œê·¸ ë‹«íŒ ë’¤ í•œ í”„ë ˆì„(ì •í™•íˆ ë‘ í”„ë ˆì„) ëŒ€ê¸°
		async function closeDialogAndWait(dlg) {
		  if (dlg?.open) dlg.close();
		  await new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));
		}

		form.addEventListener('submit', async (e) => {
		  e.preventDefault();

		  const title = (titleEl?.value || '').trim();
		  let target;
		  if (hasTargetEl) {
		    target = Number(targetEl.value);
		  } else {
		    const defaultTarget = editingId && editingGoalSnapshot ? editingGoalSnapshot.target : 20000;
		    const raw = window.prompt('ëª©í‘œ ê¸ˆì•¡(ì›)ì„ ì…ë ¥í•˜ì„¸ìš”.', String(defaultTarget));
		    if (raw === null) return;
		    target = Number(String(raw).replaceAll(',', '').trim());
		  }
		  const goalType = Number.parseInt(iconEl?.value ?? '', 10);

		  if (!title || !Number.isFinite(target) || target <= 0 || !Number.isFinite(goalType)) {
		    // ë‹¤ì´ì–¼ë¡œê·¸ë¥¼ ë‹«ì§€ ì•Šê³  ê²½ê³ ë¥¼ ë„ì›Œì•¼ í•  ë•ŒëŠ” targetì„ dlgë¡œ ì§€ì •
		    await showAlert({
		      title: 'ì…ë ¥ê°’ í™•ì¸',
		      text: 'ì œëª©/ê¸ˆì•¡/ì•„ì´ì½˜ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•˜ì„¸ìš”.',
		      icon: 'warning',
		      target: dlg       // â† SweetAlertì„ ë‹¤ì´ì–¼ë¡œê·¸ ë‚´ë¶€ì— ë Œë”
		    });
		    return;
		  }

		  const payload = { goal_name: title, target_amount: target, goal_type: goalType };

		  try {
		    if (editingId) {
		      await api.patch(editingId, payload);
		      await closeDialogAndWait(dlg); // â† ë¨¼ì € ë‹«ê¸°
		      await showAlert({ title: 'ìˆ˜ì • ì™„ë£Œ', text: 'ëª©í‘œê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.', icon: 'success' });
		    } else {
		      await api.create(payload);
		      await closeDialogAndWait(dlg); // â† ë¨¼ì € ë‹«ê¸°
		      await showAlert({ title: 'ì €ì¥ ì„±ê³µ', text: 'ìƒˆ ëª©í‘œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', icon: 'success' });
		    }
		    await reload();
		  } catch (err) {
		    // ì—ëŸ¬ëŠ” ë‹¤ì´ì–¼ë¡œê·¸ë¥¼ ìœ ì§€í•˜ê³ , ë‹¤ì´ì–¼ë¡œê·¸ ë‚´ë¶€ì— ì•Œë¦¼ì„ ë¶™ì´ë©´ ë’¤ë¡œ ê¹”ë¦¬ì§€ ì•ŠìŒ
		    await showAlert({
		      title: err?.code === 409 ? 'ìƒì„± ë¶ˆê°€' : 'ì˜¤ë¥˜',
		      text: (err?.message) || (err?.toString()) || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜',
		      icon: err?.code === 409 ? 'warning' : 'error',
		      target: dlg
		    });
		  }
		});

		function openEdit(id, g) {
		  editingId = id;
		  editingGoalSnapshot = { ...g }; // target ë“± ê¸°ì¡´ ê°’ ë³´ê´€
		  if (titleEl) titleEl.value = g.title || '';
		  if (targetEl) targetEl.value = g.target || '';
		  if (iconEl)  iconEl.value  = String(g.icon ?? '');
		  dlg.showModal ? dlg.showModal() : dlg.removeAttribute('hidden');
		}

		/* ==== Actions ==== */
		async function removeGoal(id) {
		  const { isConfirmed } = await showConfirm({
		    title: 'ì‚­ì œ í™•ì¸',
		    text: 'ì •ë§ ì‚­ì œí• ê¹Œìš”?',
		    icon: 'warning',
		    confirmButtonText: 'ì‚­ì œ',
		    cancelButtonText: 'ì·¨ì†Œ'
		  });
		  if (!isConfirmed) return;

		  try {
		    await api.remove(id);
		    await showAlert({ title: 'ì‚­ì œ ì™„ë£Œ', text: 'ëª©í‘œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', icon: 'success' });
		    await reload();
		  } catch (err) {
		    await showAlert({
		      title: 'ì˜¤ë¥˜',
		      text: (err && err.message) ? err.message : String(err),
		      icon: 'error'
		    });
		  }
		}

		async function markDone(id) {
		  try {
		    await api.complete(id);
		    await showAlert({ title: 'ë‹¬ì„± ì²˜ë¦¬', text: 'ë‹¬ì„± ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.', icon: 'success' });
		    await reload();
		  } catch (err) {
		    await showAlert({
		      title: 'ì˜¤ë¥˜',
		      text: (err && err.message) ? err.message : String(err),
		      icon: 'error'
		    });
		  }
		}

		/* ==== Start ==== */
		document.getElementById('cta-start')?.addEventListener('click', () => btnAdd?.click());
		reload();
	</script>

	</main>
</body>
</html>